# TODO 상세 다이얼로그 개선사항

## 개요

TODO 상세 다이얼로그를 상하 분할 레이아웃으로 개선하고, LLM 기반 요약 및 회신 초안 생성 기능을 추가했습니다.

## 주요 개선사항

### 1. 상하 분할 레이아웃

#### 상단: 원본 메시지 영역
- 우선순위, 요청자, 유형, 마감일 등 메타 정보 표시
- 원본 메시지 내용 전체 표시 (읽기 전용)
- 발신자, 제목, 플랫폼 정보 포함

#### 하단: 요약 및 액션 영역
- 요약 표시 영역 (회색 박스)
- "📋 요약 생성" 버튼: LLM을 사용하여 즉시 요약 생성
- "✉️ 회신 초안 작성" 버튼: LLM을 사용하여 회신 초안 생성
- 회신 초안 표시 영역 (생성 후 표시)

### 2. LLM 기반 요약 생성

#### 기능
- 원본 메시지를 3-5개의 불릿 포인트로 간결하게 요약
- 핵심 내용만 추출하여 빠른 파악 가능
- 최대 2000자까지 처리

#### 사용 방법
1. TODO 항목 클릭하여 상세 다이얼로그 열기
2. "📋 요약 생성" 버튼 클릭
3. LLM이 요약을 생성하여 표시

#### 프롬프트
```
당신은 업무 메시지를 간결하게 요약하는 전문가입니다. 
핵심 내용만 3-5개의 불릿 포인트로 요약하세요.
```

### 3. LLM 기반 회신 초안 생성

#### 기능
- 원본 메시지에 대한 정중하고 명확한 회신 초안 생성
- 발신자 정보를 포함하여 맥락에 맞는 회신 작성
- 최대 2000자까지 처리

#### 사용 방법
1. TODO 항목 클릭하여 상세 다이얼로그 열기
2. "✉️ 회신 초안 작성" 버튼 클릭
3. LLM이 회신 초안을 생성하여 표시

#### 프롬프트
```
당신은 업무 이메일 회신을 작성하는 전문가입니다. 
정중하고 명확한 회신을 작성하세요.
```

### 4. TODO 리스트 요약 개선

#### 기존 문제
- TODO 리스트에 긴 설명이 그대로 표시되어 가독성 저하
- 스크롤이 많이 필요하여 전체 파악이 어려움

#### 개선 사항
- 각 TODO 항목에 간단한 요약 표시 (회색 박스)
- 첫 문장만 추출하여 최대 80자로 제한
- 줄바꿈 제거 및 공백 정리로 깔끔한 표시

#### 구현
```python
def _create_brief_summary(self, description: str) -> str:
    """설명을 간단하게 요약 (최대 80자)"""
    if not description:
        return ""
    
    # 줄바꿈 제거 및 공백 정리
    cleaned = " ".join(description.split())
    
    # 첫 문장만 추출
    sentences = cleaned.replace("。", ".").split(".")
    first_sentence = sentences[0].strip() if sentences else cleaned
    
    # 최대 80자로 제한
    if len(first_sentence) > 80:
        return first_sentence[:77] + "..."
    
    return first_sentence
```

## 기술 스택

### LLM 공급자 지원
- Azure OpenAI
- OpenAI
- OpenRouter

### API 호출
- `requests` 라이브러리 사용
- 타임아웃: 30초
- 최대 토큰: 500 (요약/회신)

### 에러 처리
- API 호출 실패 시 사용자에게 명확한 오류 메시지 표시
- 로그에 상세 오류 정보 기록
- 버튼 상태 복원 (재시도 가능)

## 사용자 경험

### 버튼 상태 관리
- 생성 중: "⏳ 생성 중..." 표시 및 버튼 비활성화
- 완료 후: 버튼 재활성화 및 원래 텍스트 복원
- 에러 발생 시: 버튼 재활성화 및 재시도 가능

### 시각적 피드백
- 요약 생성 중: "요약을 생성하는 중입니다..." 표시
- 회신 생성 중: "회신 초안을 생성하는 중입니다..." 표시
- 완료 후: 생성된 내용 즉시 표시

### 레이아웃
- 상단 영역: 원본 메시지 (최소 높이 200px)
- 하단 영역: 요약 (최소 높이 120px) + 회신 (최소 높이 150px)
- 구분선으로 명확한 영역 분리

## 성능 최적화

### 토큰 절약
- 원본 메시지를 최대 2000자로 제한
- 간결한 시스템 프롬프트 사용
- 최대 토큰 수 제한 (500)

### 응답 속도
- 타임아웃 30초 설정
- 비동기 처리 없이 동기 호출 (UI 블로킹 최소화)

## 향후 개선 계획

### 1. 캐싱
- 동일한 메시지에 대한 요약/회신 캐싱
- 재생성 시 캐시 사용으로 속도 향상

### 2. 배치 처리
- 여러 TODO 항목을 한 번에 요약
- 병렬 처리로 전체 시간 단축

### 3. 커스터마이징
- 요약 스타일 선택 (간결/상세)
- 회신 톤 선택 (정중/친근)
- 언어 선택 (한국어/영어)

### 4. 편집 기능
- 생성된 요약/회신 편집 가능
- 편집 내용 저장 및 재사용

## 관련 파일

- `ui/todo_panel.py`: TODO 패널 및 상세 다이얼로그
- `nlp/summarize.py`: 메시지 요약 모듈
- `config/settings.py`: LLM 설정

## 참고 자료

- [PyQt6 문서](https://www.riverbankcomputing.com/static/Docs/PyQt6/)
- [Azure OpenAI API](https://learn.microsoft.com/en-us/azure/ai-services/openai/)
- [OpenAI API](https://platform.openai.com/docs/api-reference)
